def gen_superinc(n):
    """
    generates a superincreasing sequence of size n
    """
    r = [0]*n
    r[0] = ZZ.random_element(10, n^9)
    for i in range(1,n):
        r[i] = ZZ.random_element(2*r[i-1]+1, 11*r[i-1])
    return r

def keyGen(n):
    """
    generates a public key M and a private key (A^-1, r, q)
    """
    P = Primes()
    r = gen_superinc(n)
    q = P.next(ZZ.random_element(5, 100)*r[n-1])
    A = ZZ.random_element(2, q)

    M = [A*r[i] for i in range(n)]
    Ainv = 1/A % q
    return M, Ainv, r, q

def Enc(m, pk):
    """
    encrypts m under pk
    """
    assert(len(m)==len(pk))
    return sum([m[i]*pk[i] for i in range(len(m))])

def Dec(n, c, sk1, sk2, q):
    """
    decrypts c unders (sk1, sk2, q)
    """
    c2 = (sk1*c)%q
    m = [0]*len(sk2)
    for i in range(len(sk2)):
        if c2>=sk2[n-i-1]:
            m[n-i-1] = 1
            c2 = c2 - sk2[n-i-1]
    return m


def attack(n, pk, cipher):
    """
    TESTS::
        sage: attack(70, [32606659912595599187366700343108679483902926975194051889029271338148970133346485083108671, 343321457203677172026546794962897454645773505810078932757530715016943297087981707058908939, 2213055301330526925973051742448766603299004795598651283089240842117324932971955582425370042, 8180658525544351919875847212512802942711449069382323669682575772275481339524916963068122496, 31185578738795686959180648437244237453858635294351478027703027632156729341020015139562306930, 233650919937563196871807478215788187931132148228733922272138473620066250609909468145601255628, 1494163280670374134511072319079610345825480774966149631751727757983573201548724176011217611523, 5281127868783035512797506571043716300690242605538500145682182155048036438427130408420014088615, 25581491667173334882752813470314698190448201419099304050746588115032845885721525240649495144567, 236295293457050829244256618333044881753019778973797042880003679738154113164977886113900593954932, 795400173638182332756497148594171537227935273936227408042872435723179775285649425232163077290934, 1716224788138012782200174028344006387911323099063835592246053487200826190028007989691906658916203, 11164931765259269572663372761291648224106793424473222626117530802118577169013036018417550726714994, 100376112906369010484098850870442682410540683158165938488377994514055276728637788293458735710386829, 391348206086007948172757030063341277559957442580742497080470777942372134485007487093746670955078980, 2212949776740954165024085096107019062871771424910355806923810137064323843705741319609958529184217888, 11463668028167056929570937687959353950317440383012640547156265428295652705766413429572060891915296240, 109706495730552010203143297801695007447338256657152599757547540871405034476535738828619716805316803544, 299366746707695554432692045267113812590247732069770006315500847326584696779654963421232884065108611838, 706160230184766621635335766743385112104637783250241021182232552105777524132789769178057877894243504842, 6791103505455847099067673301836516913654799986582965230073011939802010327843579867930464319791168901665, 65637247611022009780064579202706123100278706533056308890879138705343630856952384539230943366659608335465, 482724458974798319787058847965820568434173150558240607739633481031789102514576971069769939639772236120198, 1649506254171543351736669605802173326836782748833208107504681644429371536044110230495645947963462457685794, 7835351262187645976758000000022772046144583191677881433018401471680011905969621580013762430787088888915944, 23790872127659054595637620985974147767342751883380452855896282533324198646681116407821099265790255897729039, 187440911687235585582803914583276374911948123625573439489291579907507838398013800308280144466940485449711657, 931218362772216756969309103653982073434580784621394693061562037977229560316559163060713496694674311153664030, 4549481291165911035316356298010559948370983569008841799443074250741690816927367439346710229630203100356206945, 46588525608988988982600573610139970919440573566535176773487623809888570073112553737814274336197196047180873864, 397322935819094893340698348716632297240276203312266996945619058897530851958208801973345376463214354881006207367, 2312154778020126743729360675291725538691106118505087815161041964429092660004459055197960326784235257016571222390, 18271259698095124155423714733174007783479201952164742536116190609360245312889620606806123467622887430266325357712, 78583748398675937824538333088082011427707544053541177523734782380291399600708356446716384473957811270178466713276, 255605900901643342334234599628431810833317867464853047716924998594009938846715182929487801397656617985680149868540, 1036688592041436451129882936724208795845724165494891356461289786969588008305945041960755245408259388737082771977999, 10018933553460820995156428997982868978335399403677800913863173419000912842514281524451204424493875893970744130937405, 35848105004518110924210580183979621614665182104657767650766567376800565596356320695426269112637560709554492104897073, 268599591837641736561210808308996648187512700171618533701645446951773733601208593016997420091541929093460320750786514, 2545815810727013736314482246618890284053410333622051820721730638932254943084263265165617728353902607862527817224160219, 26447694993409116241681115600613194449234738319508258826349127517907605054226083610933964399485627752944735397746377187, 289127220752342030611465971266248287252527901014802305238847775531019442206201112820917845593747970695871524842833453081, 2691324806226906507830882308107651097008343493915478007803791678119860802918471524158499249996143650020604398608868025701, 29545375359233523883846895905418231250122502930627027152274548085733145728040602849339896154340082213453707438474955347862, 150027978468806610687157847976058181108894768494011119375213135931327829444013920808930256505465662138426016696372889293404, 1448750842520972951349224429987586330616238065210973143716421715530980838604018146884897431524657535615392523206415112236904, 14031264820251906798857765245416646478439571245554539874708441226429531431214495017287683657051478317823968505636189715524158, 132118345825396514079940083171242349180185471539601630224310588195023333126934676038318072204672707251046295625366764036515254, 563581747781227789992722477470117079872449060551012215260597671315477741498468433723081084191051970627929228220732192697596414, 4980697609509682048899261702046197884592039037263454459877635080891472853046400610429116777265992666132114724719916250266724915, 53537954576536566762195863069211721247489488514499643106690468915530403931008371290066975652219994942953031685323669355932930859, 322931972154081030441468328291685260459188667536946760838384748571062881019615369148019197653181307622320639571541156888640318477, 3430283819426037478141784350107928848931079986265469203532632431697052542648495557291207319637784882984713027795048281990250999465, 30662680186423827837498970945391549720814352475698575535774367687569155690231896608504375914175971150803908624959274799942336163870, 329231136297322476014321812493523926448175130550881465559627839681943273034184383756223079989447308959151785470802605331056213382327, 1490354461852119778818665541857441212950127979112062787847565960692659996781274842280924801437603118017828824410754725986047209557350, 11635581088481177386163636393994999962249221165369824968203517425290181051198618395508517793621517049770958070296846902903991289467292, 76114934970846192293249999417167820529981673884750898791458593180813487623897917022533885957422831978175971797629800060827955142897153, 800224161838047751030180400775055717220431770023074885796518805035100073511360219467506528365205350780312466280784071677263165003271412, 8304832031484112164841789835082338011470472549440289966299898322042505912144132539934810249742646340183459176573907722810670146392059180, 18717005351490371961808410816504559548498034148939199065116643854801654935236704588134240233221928959856032238177826455307556457034779826, 74843284952203304884295953952099516988852023646806661085880086757468918610319122409932459177381891981260474630495221583879744033164006821, 375592334747031352362495044658533998909293735529999051361862859446126725861589991003617202331442071691477917896911851198639601334004540592, 3694317872910136607986973219082265381472404270473726333753542462265365270039734308405073210734428931291021216455172060970482303967424291649, 26109591280375862637445495131832014619386045157184155490586658566951427167136820584260274101951425771069781780388456787863454517502513753128, 262131097403158316600336568301165141374039287009643528194503985675684736521641813314382717729556230121596629207022679265356664990360239838705, 1636002469333928823293494835016471703737309912566220349602195032770658969143422524105351371612015229290238693904940047423111476554684677583758, 12319498384142201956911676022691432577116352436298280148742566023081038260763545208380099385264797001769319744114172264584953863224625243810135, 111430145764393034458690266687266051336072100049276320163104465169948096792377241359068667994025298713375069163431770334402780998566609298250091, 1065311539980788612766165665682495772499387824562400641287181103278143646930624264886383905646374608240344449688451153883710179505510190587643896], 1636480003235554320867806037580660517984339058177692262653487132650932206994768316933554349231040962668929828528985601590294526019632758729230)
        [0, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0]
        sage: attack(70, [32606659912595599187366700343108679483902926975194051889029271338148970133346485083108671, 343321457203677172026546794962897454645773505810078932757530715016943297087981707058908939, 2213055301330526925973051742448766603299004795598651283089240842117324932971955582425370042, 8180658525544351919875847212512802942711449069382323669682575772275481339524916963068122496, 31185578738795686959180648437244237453858635294351478027703027632156729341020015139562306930, 233650919937563196871807478215788187931132148228733922272138473620066250609909468145601255628, 1494163280670374134511072319079610345825480774966149631751727757983573201548724176011217611523, 5281127868783035512797506571043716300690242605538500145682182155048036438427130408420014088615, 25581491667173334882752813470314698190448201419099304050746588115032845885721525240649495144567, 236295293457050829244256618333044881753019778973797042880003679738154113164977886113900593954932, 795400173638182332756497148594171537227935273936227408042872435723179775285649425232163077290934, 1716224788138012782200174028344006387911323099063835592246053487200826190028007989691906658916203, 11164931765259269572663372761291648224106793424473222626117530802118577169013036018417550726714994, 100376112906369010484098850870442682410540683158165938488377994514055276728637788293458735710386829, 391348206086007948172757030063341277559957442580742497080470777942372134485007487093746670955078980, 2212949776740954165024085096107019062871771424910355806923810137064323843705741319609958529184217888, 11463668028167056929570937687959353950317440383012640547156265428295652705766413429572060891915296240, 109706495730552010203143297801695007447338256657152599757547540871405034476535738828619716805316803544, 299366746707695554432692045267113812590247732069770006315500847326584696779654963421232884065108611838, 706160230184766621635335766743385112104637783250241021182232552105777524132789769178057877894243504842, 6791103505455847099067673301836516913654799986582965230073011939802010327843579867930464319791168901665, 65637247611022009780064579202706123100278706533056308890879138705343630856952384539230943366659608335465, 482724458974798319787058847965820568434173150558240607739633481031789102514576971069769939639772236120198, 1649506254171543351736669605802173326836782748833208107504681644429371536044110230495645947963462457685794, 7835351262187645976758000000022772046144583191677881433018401471680011905969621580013762430787088888915944, 23790872127659054595637620985974147767342751883380452855896282533324198646681116407821099265790255897729039, 187440911687235585582803914583276374911948123625573439489291579907507838398013800308280144466940485449711657, 931218362772216756969309103653982073434580784621394693061562037977229560316559163060713496694674311153664030, 4549481291165911035316356298010559948370983569008841799443074250741690816927367439346710229630203100356206945, 46588525608988988982600573610139970919440573566535176773487623809888570073112553737814274336197196047180873864, 397322935819094893340698348716632297240276203312266996945619058897530851958208801973345376463214354881006207367, 2312154778020126743729360675291725538691106118505087815161041964429092660004459055197960326784235257016571222390, 18271259698095124155423714733174007783479201952164742536116190609360245312889620606806123467622887430266325357712, 78583748398675937824538333088082011427707544053541177523734782380291399600708356446716384473957811270178466713276, 255605900901643342334234599628431810833317867464853047716924998594009938846715182929487801397656617985680149868540, 1036688592041436451129882936724208795845724165494891356461289786969588008305945041960755245408259388737082771977999, 10018933553460820995156428997982868978335399403677800913863173419000912842514281524451204424493875893970744130937405, 35848105004518110924210580183979621614665182104657767650766567376800565596356320695426269112637560709554492104897073, 268599591837641736561210808308996648187512700171618533701645446951773733601208593016997420091541929093460320750786514, 2545815810727013736314482246618890284053410333622051820721730638932254943084263265165617728353902607862527817224160219, 26447694993409116241681115600613194449234738319508258826349127517907605054226083610933964399485627752944735397746377187, 289127220752342030611465971266248287252527901014802305238847775531019442206201112820917845593747970695871524842833453081, 2691324806226906507830882308107651097008343493915478007803791678119860802918471524158499249996143650020604398608868025701, 29545375359233523883846895905418231250122502930627027152274548085733145728040602849339896154340082213453707438474955347862, 150027978468806610687157847976058181108894768494011119375213135931327829444013920808930256505465662138426016696372889293404, 1448750842520972951349224429987586330616238065210973143716421715530980838604018146884897431524657535615392523206415112236904, 14031264820251906798857765245416646478439571245554539874708441226429531431214495017287683657051478317823968505636189715524158, 132118345825396514079940083171242349180185471539601630224310588195023333126934676038318072204672707251046295625366764036515254, 563581747781227789992722477470117079872449060551012215260597671315477741498468433723081084191051970627929228220732192697596414, 4980697609509682048899261702046197884592039037263454459877635080891472853046400610429116777265992666132114724719916250266724915, 53537954576536566762195863069211721247489488514499643106690468915530403931008371290066975652219994942953031685323669355932930859, 322931972154081030441468328291685260459188667536946760838384748571062881019615369148019197653181307622320639571541156888640318477, 3430283819426037478141784350107928848931079986265469203532632431697052542648495557291207319637784882984713027795048281990250999465, 30662680186423827837498970945391549720814352475698575535774367687569155690231896608504375914175971150803908624959274799942336163870, 329231136297322476014321812493523926448175130550881465559627839681943273034184383756223079989447308959151785470802605331056213382327, 1490354461852119778818665541857441212950127979112062787847565960692659996781274842280924801437603118017828824410754725986047209557350, 11635581088481177386163636393994999962249221165369824968203517425290181051198618395508517793621517049770958070296846902903991289467292, 76114934970846192293249999417167820529981673884750898791458593180813487623897917022533885957422831978175971797629800060827955142897153, 800224161838047751030180400775055717220431770023074885796518805035100073511360219467506528365205350780312466280784071677263165003271412, 8304832031484112164841789835082338011470472549440289966299898322042505912144132539934810249742646340183459176573907722810670146392059180, 18717005351490371961808410816504559548498034148939199065116643854801654935236704588134240233221928959856032238177826455307556457034779826, 74843284952203304884295953952099516988852023646806661085880086757468918610319122409932459177381891981260474630495221583879744033164006821, 375592334747031352362495044658533998909293735529999051361862859446126725861589991003617202331442071691477917896911851198639601334004540592, 3694317872910136607986973219082265381472404270473726333753542462265365270039734308405073210734428931291021216455172060970482303967424291649, 26109591280375862637445495131832014619386045157184155490586658566951427167136820584260274101951425771069781780388456787863454517502513753128, 262131097403158316600336568301165141374039287009643528194503985675684736521641813314382717729556230121596629207022679265356664990360239838705, 1636002469333928823293494835016471703737309912566220349602195032770658969143422524105351371612015229290238693904940047423111476554684677583758, 12319498384142201956911676022691432577116352436298280148742566023081038260763545208380099385264797001769319744114172264584953863224625243810135, 111430145764393034458690266687266051336072100049276320163104465169948096792377241359068667994025298713375069163431770334402780998566609298250091, 1065311539980788612766165665682495772499387824562400641287181103278143646930624264886383905646374608240344449688451153883710179505510190587643896], 125673895624873991250183420560503838096542086809091968073567660903432249817959720278855567022760588275232157688211053972788089947070864507960185)
        [0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0]
    """
    B = matrix(ZZ, n+1, n+1)
    for i in range(n):
        B[i,i] = 2
        B[i, n] = pk[i]
        B[n, i] = 1
    B[n,n] = cipher
    BLLL = B.LLL()
    assert(BLLL[0,n]==0)
    #print(BLLL[0])
    coeff = [0]*n
    for i in range(n):
        if BLLL[0,i]==-1:
            coeff[i] = 1
    return coeff

#A1, short = attack(pk, cipher)
#print(short)

"""
def generate_instance(n):
    pk, sk1, sk2, q = keyGen(n)
    #print('sk2:', sk2)
    nsamples = 3
    mes = [0]*nsamples
    cipher = [0]*nsamples
    for i in range(nsamples):
        mes[i] = [ZZ.random_element(0,2) for _ in range(n)]
        cipher[i] = Enc(mes[i], pk)
        dec = Dec(n, cipher[i], sk1, sk2, q)
        assert(dec == mes[i])
        short = attack(n, pk, cipher[i])
        assert(short == mes[i])
    return mes, cipher, pk


n = 120
mes, cipher, pk = generate_instance(n)
print(pk)
print(cipher[0])
print(attack(n, pk, cipher[0]))
print(mes[0])
"""
